name: Integration Testing

on:
  workflow_dispatch:
    inputs:
      pr_link:
        description: 'PR URL (e.g. https://github.com/llvm/llvm-project/pull/12345)'
        required: true
      check_name:
        description: 'Clang-tidy check name'
        required: true
      extra_config:
        description: 'Check options (e.g. VariableCase: camelBack)'
        required: false
  issues:
    types: labeled

jobs:
  build:
    if: github.event_name == 'workflow_dispatch' || github.event.label.name == 'cpp' || github.event.label.name == 'c'
    runs-on: ubuntu-latest
    timeout-minutes: 360

    permissions:
      issues: write
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 1

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build build-essential python3-dev zlib1g-dev python3-yaml zip unzip

      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git -C llvm-project checkout .
          git -C llvm-project clean -fdx

      - name: Parse Inputs
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            {
              echo "${{ github.event.inputs.pr_link }} ${{ github.event.inputs.check_name }}"
              echo "${{ github.event.inputs.extra_config }}"
            } | python3 parse_issue.py $GITHUB_ENV
          else
            echo "${{ github.event.issue.body }}" | python3 parse_issue.py $GITHUB_ENV
          fi

          echo "PR_LINK: $PR_LINK"
          echo "CHECK_NAME: $CHECK_NAME"
          echo "TIDY_CONFIG: $TIDY_CONFIG"

      - name: Set up patch
        run: |
          ${{ github.workspace }}/apply_patch.sh
        env:
          GITHUB_PATCH_ID: ${{ env.PR_LINK }}

      - name: Build Clang-tidy
        run: ${{ github.workspace }}/build.sh

      - name: Run Check on cppcheck
        run: |
          chmod +x testers/cppcheck.sh
          ./testers/cppcheck.sh "${{ env.CHECK_NAME }}"
        env:
          CHECK_NAME: ${{ env.CHECK_NAME }}

      - name: Run Check on LLVM
        run: |
          chmod +x testers/llvm.sh
          ./testers/llvm.sh "${{ env.CHECK_NAME }}"
        env:
          CHECK_NAME: ${{ env.CHECK_NAME }}

      - name: Generate Report
        run: |
          python3 testers/generate_report.py

      - name: Artifacts
        uses: actions/upload-artifact@v4
        id: artifact
        with:
          name: ctit-logs
          path: |
            logs/
            issue.md

      - name: Report
        if: github.event_name != 'workflow_dispatch'
        uses: thollander/actions-comment-pull-request@v2
        with:
          filePath: issue.md
